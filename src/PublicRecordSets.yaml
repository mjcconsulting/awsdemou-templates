AWSTemplateFormatVersion: 2010-09-09
Description: PublicRecordSets Template.
  This creates Manual Public RecordSets in a Public HostedZone. This is more an example of how to create additional
  Manual DNS records at this point.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Stack Dependencies
        Parameters:
          - PublicHostedZoneStackName
      - Label:
          default: RecordSet Configuration
        Parameters:
          - SPFTXTValue
          - CheckTXTValue
          - WWWCNAMEValue
    ParameterLabels:
      PublicHostedZoneStackName:
        default: PublicHostedZone Stack Name
      SPFTXTValue:
        default: SPF TXT Value
      CheckTXTValue:
        default: Check TXT Value
      WWWCNAMEValue:
        default: WWW CNAME Value
Parameters:
  PublicHostedZoneStackName:
    Description: Name of the CloudFormation Stack containing the Public HostedZone
    Type: String
    MaxLength: 64
    Default: PublicHostedZone
    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  SPFTXTValue:
    Description: Optional value of SPF TXT Record (without quotes)
    Type: String
    Default: ''
    AllowedPattern: (^$|^v=spf1.*$)
    ConstraintDescription: must be a a valid SPF v1 string, if specified.
  CheckTXTValue:
    Description: Optional value of Check TXT Record (without quotes)
    Type: String
    Default: ''
    AllowedPattern: (^$|^[A-Za-z0-9]{32}$)
    ConstraintDescription: must be a string of 32 alphanumeric characters, if specified.
  WWWCNAMEValue:
    Description: Optional value of WWW CNAME Record
    Type: String
    Default: ''
    #AllowedPattern: (^$|^[A-Za-z0-9]{32}$) #TODO: Correct to optional CNAME Pattern
    ConstraintDescription: must be a a valid CNAME, if specified.
Conditions:
  ConfigureSPFTXTRecordSet: !Not [ !Equals [ !Ref SPFTXTValue, '' ]]
  ConfigureCheckTXTRecordSet: !Not [ !Equals [ !Ref CheckTXTValue, '' ]]
  ConfigureWWWCNAMERecordSet: !Not [ !Equals [ !Ref WWWCNAMEValue, '' ]]
Resources:
  PublicSPFTXTRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !ImportValue
        Fn::Sub: ${PublicHostedZoneStackName}-PublicHostedZone
      Name: !Sub
        - ${PublicDomain}.
        - PublicDomain: !ImportValue
            Fn::Sub: ${PublicHostedZoneStackName}-PublicDomain
      Type: TXT
      TTL: 1800
      ResourceRecords:
        - !Sub '"${SPFTXTValue}"'
    Condition: ConfigureSPFTXTRecordSet
  PublicCheckTXTRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !ImportValue
        Fn::Sub: ${PublicHostedZoneStackName}-PublicHostedZone
      Name: !Sub
        - check.${PublicDomain}.
        - PublicDomain: !ImportValue
            Fn::Sub: ${PublicHostedZoneStackName}-PublicDomain
      Type: TXT
      TTL: 1800
      ResourceRecords:
        - !Sub '"${CheckTXTValue}"'
    Condition: ConfigureCheckTXTRecordSet
  PublicWWWCNAMERecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !ImportValue
        Fn::Sub: ${PublicHostedZoneStackName}-PublicHostedZone
      Name: !Sub
        - www.${PublicDomain}.
        - PublicDomain: !ImportValue
            Fn::Sub: ${PublicHostedZoneStackName}-PublicDomain
      Type: CNAME
      TTL: 300
      ResourceRecords:
        - !Ref WWWCNAMEValue
    Condition: ConfigureWWWCNAMERecordSet
