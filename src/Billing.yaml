AWSTemplateFormatVersion: 2010-09-09
Description: Billing Template (Consolidated).
  This creates Billing SNS Topics & Subscriptions and CloudWatch Alarms.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Topic Configuration
        Parameters:
          - TopicPrefix
      - Label:
          default: Subscription Configuration
        Parameters:
          - BillsTopicEmailEndpoint
          - UrgentBillsTopicEmailEndpoint
          - UrgentBillsTopicPhoneEndpoint
      - Label:
          default: Function Configuration
        Parameters:
          - BillingAlarmThresholdCalculatorLogRetention
      - Label:
          default: Environment Configuration
        Parameters:
          - EnvironmentType
    ParameterLabels:
      TopicPrefix:
        default: Topic Prefix
      BillsTopicEmailEndpoint:
        default: Bills Topic Email Endpoint
      UrgentBillsTopicEmailEndpoint:
        default: UrgentBills Topic Email Endpoint
      UrgentBillsTopicPhoneEndpoint:
        default: UrgentBills Topic Phone Endpoint
      EnvironmentType:
        default: Environment Type
Parameters:
  TopicPrefix:
    Description: Optional Prefix for Topic Display Name
    Type: String
    Default: ''
    AllowedPattern: (^$|^[A-Z][A-Z0-9]{1,4}$)
    ConstraintDescription: must begin with an upper-case letter and consist of 1 to 4 additional upper-case letters or digits, if specified.
  BillsTopicEmailEndpoint:
    Description: Email Endpoint for Bills Topic. If blank, no standard subscription will be created
    Type: String
    Default: ''
    AllowedPattern: (^$|[^\s@]+@[^\s@]+\.[^\s@]+$)
    ConstraintDescription: must be a valid email address.
  UrgentBillsTopicEmailEndpoint:
    Description: Email Endpoint for UrgentBills Topic. If blank, no standard subscription will be created
    Type: String
    Default: ''
    AllowedPattern: (^$|[^\s@]+@[^\s@]+\.[^\s@]+$)
    ConstraintDescription: must be a valid email address.
  UrgentBillsTopicPhoneEndpoint:
    Description: Phone Endpoint for UrgentBills Topics. If blank, no standard subscription will be created
    Type: String
    Default: ''
    AllowedPattern: (^$|^\+\d{11,12}$)
    ConstraintDescription: must be a valid phone number.
  EnvironmentType:
    Description: Type of the Environment to configure alarms for monitoring costs. Used to select which Alarms to create
    Type: String
    Default: nano
    AllowedValues:
      - none # To update, switch to none, then any new type - otherwise Alarms which exist will conflict with new Alarms
      - nano
      - micro
      - small
      - medium
      - large
      - xlarge
      - 2xlarge
      - 4xlarge
      - 8xlarge
      - 16xlarge
      - 32xlarge
    ConstraintDescription: must be none, nano, micro, small, medium, large, xlarge, 2xlarge, 4xlarge, 8xlarge, 16xlarge or 32xlarge.
Mappings:
  ThresholdMap:
    Low: # 0 = Evenly-spaced NormalAlarms throughout Month - vs - 50% or 75% of Normal = Alarms only near EOM
      none: 0
      nano: 0
      micro: 0
      small: 0
      medium: 0
      large: 0
      xlarge: 0
      2xlarge: 0
      4xlarge: 0
      8xlarge: 0
      16xlarge: 0
      32xlarge: 0
    Normal:
      none: 0
      nano: 50
      micro: 100
      small: 250
      medium: 500
      large: 1000
      xlarge: 2500
      2xlarge: 5000
      4xlarge: 10000
      8xlarge: 25000
      16xlarge: 50000
      32xlarge: 100000
    High: # 2 * Normal
      none: 0
      nano: 100
      micro: 200
      small: 500
      medium: 1000
      large: 2000
      xlarge: 5000
      2xlarge: 10000
      4xlarge: 20000
      8xlarge: 50000
      16xlarge: 100000
      32xlarge: 200000
  AlarmsMap:
    Normal: # Can be 0, 5, 10 or 20 - enforced in Lambda Function
      none: 0
      nano: 5
      micro: 10
      small: 10
      medium: 10
      large: 10
      xlarge: 10
      2xlarge: 10
      4xlarge: 20
      8xlarge: 20
      16xlarge: 20
      32xlarge: 20
    High: # Can be 0, 5, 10 or 20 - enforced in Lambda Function
      none: 0
      nano: 10
      micro: 10
      small: 10
      medium: 10
      large: 10
      xlarge: 10
      2xlarge: 10
      4xlarge: 20
      8xlarge: 20
      16xlarge: 20
      32xlarge: 20
Rules:
  ValidateRegion:
    Assertions:
      - Assert: !Equals [ !Ref 'AWS::Region', us-east-1 ]
        AssertDescription: This Template can only be used in Region us-east-1.
Conditions:
  ConfigureTopicPrefix: !Not [ !Equals [ !Ref TopicPrefix, '' ]]
  ConfigureBillsTopicEmailSubscription: !Not [ !Equals [ !Ref BillsTopicEmailEndpoint, '' ]]
  ConfigureUrgentBillsTopicEmailSubscription: !Not [ !Equals [ !Ref UrgentBillsTopicEmailEndpoint, '' ]]
  ConfigureUrgentBillsTopicPhoneSubscription: !Not [ !Equals [ !Ref UrgentBillsTopicPhoneEndpoint, '' ]]
  ConfigureNormal05: !Or [ !Equals [ !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ], 5 ],
                           !Equals [ !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ], 10 ],
                           !Equals [ !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ], 20 ]]
  ConfigureNormal10: !Or [ !Equals [ !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ], 10 ],
                           !Equals [ !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ], 20 ]]
  ConfigureNormal20: !Equals [ !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ], 20 ]
  ConfigureHigh05: !Or [ !Equals [ !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ], 5 ],
                         !Equals [ !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ], 10 ],
                         !Equals [ !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ], 20 ]]
  ConfigureHigh10: !Or [ !Equals [ !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ], 10 ],
                         !Equals [ !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ], 20 ]]
  ConfigureHigh20: !Equals [ !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ], 20 ]
Resources:
  BillsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: Bills
      DisplayName: !If
        - ConfigureTopicPrefix
        - !Sub ${TopicPrefix} Bills
        - Bills
  UrgentBillsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: UrgentBills
      DisplayName: !If
        - ConfigureTopicPrefix
        - !Sub ${TopicPrefix} Bills
        - Bills
  BillsTopicEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref BillsTopic
      Protocol: email
      Endpoint: !Ref BillsTopicEmailEndpoint
    Condition: ConfigureBillsTopicEmailSubscription
  UrgentBillsTopicEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref UrgentBillsTopic
      Protocol: email
      Endpoint: !Ref UrgentBillsTopicEmailEndpoint
    Condition: ConfigureUrgentBillsTopicEmailSubscription
  UrgentBillsTopicPhoneSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref UrgentBillsTopic
      Protocol: sms
      Endpoint: !Ref UrgentBillsTopicPhoneEndpoint
    Condition: ConfigureUrgentBillsTopicPhoneSubscription
  BillingAlarmThresholdCalculatorRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  BillingAlarmThresholdCalculatorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: BilingAlarmThresholdCalculator
      Description: A Lambda function which calculates Billing Alarm Thresholds for use in Billing Alarms. This calculates a set of Values which can be used to set Alarm Thresholds, based on Low, Normal and High Values.
      Role: !GetAtt BillingAlarmThresholdCalculatorRole.Arn
      Runtime: nodejs10.x
      Timeout: 30
      Handler: index.handler
      Code:
        ZipFile: |
          const response = require('./cfn-response');

          exports.handler = (event, context) => {
            console.info(`Request body:\n${JSON.stringify(event)}`);

            switch (event.RequestType) {
              case 'Create':
              case 'Update':
                const properties = event.ResourceProperties;
                console.info(`Validating: Parameters...`);
                const lowAmount = (properties.LowAmount) ? Number(properties.LowAmount) : 0;
                if (! Number.isInteger(lowAmount) || lowAmount < 0 || lowAmount % 10) {
                  const responseData = {Error: `Error: LowAmount invalid: must be a positive integer divisible by 10 or 0`};
                  console.error(responseData.Error);
                  response.send(event, context, response.FAILED, responseData);
                  return;
                }

                const normalAmount = (properties.NormalAmount) ? Number(properties.NormalAmount) : 'invalid';
                if (! Number.isInteger(normalAmount) || normalAmount < 0 || normalAmount <= lowAmount || normalAmount % 10) {
                  const responseData = {Error: `Error: NormalAmount invalid: must be a positive integer divisible by 10 and greater than LowAmount`};
                  console.error(responseData.Error);
                  response.send(event, context, response.FAILED, responseData);
                  return;
                }

                const highAmount = (properties.HighAmount) ? Number(properties.HighAmount) : normalAmount * 1.2;
                if (! Number.isInteger(highAmount) || highAmount < 0 || highAmount <= normalAmount || highAmount % 10) {
                  const responseData = {Error: `Error: HighAmount invalid: must be a positive integer divisible by 10 and greater than NormalAmount`};
                  console.error(responseData.Error);
                  response.send(event, context, response.FAILED, responseData);
                  return;
                }

                const normalAlarms = (properties.NormalAlarms) ? Number(properties.NormalAlarms) : 5;
                if (! /^(5|10|20)$/.test(normalAlarms)) {
                  const responseData = {Error: `Error: NormalAlarms invalid: must be 5, 10 or 20`};
                  console.error(responseData.Error);
                  response.send(event, context, response.FAILED, responseData);
                  return;
                }

                const highAlarms = (properties.HighAlarms) ? Number(properties.HighAlarms) : 5;
                if (! /^(5|10|20)$/.test(highAlarms)) {
                  const responseData = {Error: `Error: HighAlarms invalid: must be 5, 10 or 20`};
                  console.error(responseData.Error);
                  response.send(event, context, response.FAILED, responseData);
                  return;
                }

                if ((normalAmount - lowAmount) < normalAlarms) {
                  const responseData = {Error: `Error: NormalAlarms invalid: NormalAmount - LowAmount must be greater than or equal to NormalAlarms`};
                  console.error(responseData.Error);
                  response.send(event, context, response.FAILED, responseData);
                  return;
                }

                if ((highAmount - normalAmount) < highAlarms) {
                  const responseData = {Error: `Error: HighAlarms invalid: HighAmount - NormalAmount must be greater than or equal to HighAlarms`};
                  console.error(responseData.Error);
                  response.send(event, context, response.FAILED, responseData);
                  return;
                }

                console.info(`Calculating Alarm Threshholds...`);
                let responseData = {};
                for (let alarm = 1; alarm <= normalAlarms; alarm++) {
                  console.info(`Normal${alarm.toString().padStart(2,'0')}: ${(lowAmount + Math.round(((normalAmount - lowAmount) / normalAlarms) * alarm))}`);
                  responseData[`Normal${alarm.toString().padStart(2,'0')}`] = lowAmount + Math.round(((normalAmount - lowAmount) / normalAlarms) * alarm);
                }

                for (let alarm = 1; alarm <= highAlarms; alarm++) {
                  console.info(`High${alarm.toString().padStart(2,'0')}: ${(normalAmount + Math.round(((highAmount - normalAmount) / highAlarms) * alarm))}`);
                  responseData[`High${alarm.toString().padStart(2,'0')}`] = normalAmount + Math.round(((highAmount - normalAmount) / highAlarms) * alarm);
                }

                response.send(event, context, response.SUCCESS, responseData);
                break;

              case 'Delete':
                response.send(event, context, response.SUCCESS);
            }
          };
  BilingAlarmThresholdCalculator:
    Type: Custom::BilingAlarmThresholdCalculator
    Properties:
      ServiceToken: !GetAtt BillingAlarmThresholdCalculatorFunction.Arn
      LowAmount: !FindInMap [ ThresholdMap, Low, !Ref EnvironmentType ]
      NormalAmount: !FindInMap [ ThresholdMap, Normal, !Ref EnvironmentType ]
      HighAmount: !FindInMap [ ThresholdMap, High, !Ref EnvironmentType ]
      NormalAlarms: !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ]
      HighAlarms: !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ]
    Condition: ConfigureNormal05
  BillingEstimatedChargesNormalAlarm01:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal01}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal01}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal01
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal05
  BillingEstimatedChargesNormalAlarm02:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal02}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal02}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal02
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal05
  BillingEstimatedChargesNormalAlarm03:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal03}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal03}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal03
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal05
  BillingEstimatedChargesNormalAlarm04:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal04}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal04}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal04
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal05
  BillingEstimatedChargesNormalAlarm05:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal05}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal05}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal05
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal05
  BillingEstimatedChargesNormalAlarm06:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal06}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal06}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal06
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal10
  BillingEstimatedChargesNormalAlarm07:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal07}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal07}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal07
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal10
  BillingEstimatedChargesNormalAlarm08:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal08}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal08}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal08
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal10
  BillingEstimatedChargesNormalAlarm09:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal09}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal09}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal09
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal10
  BillingEstimatedChargesNormalAlarm10:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal10}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal10}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal10
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal10
  BillingEstimatedChargesNormalAlarm11:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal11}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal11}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal11
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm12:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal12}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal12}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal12
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm13:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal13}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal13}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal13
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm14:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal14}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal14}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal14
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm15:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal15}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal15}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal15
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm16:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal16}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal16}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal16
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm17:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal17}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal17}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal17
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm18:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal18}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal18}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal18
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm19:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal19}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal19}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal19
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesNormalAlarm20:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.Normal20}
      AlarmDescription: !Sub Notify BillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.Normal20}
      AlarmActions:
        - !Ref BillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.Normal20
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureNormal20
  BillingEstimatedChargesHighAlarm01:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High01}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High01}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High01
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh05
  BillingEstimatedChargesHighAlarm02:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High02}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High02}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High02
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh05
  BillingEstimatedChargesHighAlarm03:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High03}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High03}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High03
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh05
  BillingEstimatedChargesHighAlarm04:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High04}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High04}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High04
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh05
  BillingEstimatedChargesHighAlarm05:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High05}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High05}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High05
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh05
  BillingEstimatedChargesHighAlarm06:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High06}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High06}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High06
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh10
  BillingEstimatedChargesHighAlarm07:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High07}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High07}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High07
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh10
  BillingEstimatedChargesHighAlarm08:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High08}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High08}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High08
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh10
  BillingEstimatedChargesHighAlarm09:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High09}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High09}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High09
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh10
  BillingEstimatedChargesHighAlarm10:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High10}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High10}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High10
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh10
  BillingEstimatedChargesHighAlarm11:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High11}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High11}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High11
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm12:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High12}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High12}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High12
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm13:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High13}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High13}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High13
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm14:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High14}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High14}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High14
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm15:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High15}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High15}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High15
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm16:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High16}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High16}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High16
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm17:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High17}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High17}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High17
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm18:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High18}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High18}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High18
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm19:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High19}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High19}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High19
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
  BillingEstimatedChargesHighAlarm20:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub BillingEstimatedCharges-${BilingAlarmThresholdCalculator.High20}
      AlarmDescription: !Sub Notify BillsTopic and UrgentBillsTopic when AWS EstimatedCharges exceed $${BilingAlarmThresholdCalculator.High20}
      AlarmActions:
        - !Ref BillsTopic
        - !Ref UrgentBillsTopic
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Statistic: Maximum
      Dimensions:
        - Name: Currency
          Value: USD
      Period: 21600
      EvaluationPeriods: 1
      Threshold: !GetAtt BilingAlarmThresholdCalculator.High20
      ComparisonOperator: GreaterThanThreshold
    Condition: ConfigureHigh20
Outputs:
  BillsTopic:
    Description: The Bills Topic ARN
    Value: !Ref BillsTopic
  UrgentBillsTopic:
    Description: The UrgentBills Topic ARN
    Value: !Ref UrgentBillsTopic
  LowAmount:
    Description: The Low Amount used to calculate Alarm Thresholds
    Value: !FindInMap [ ThresholdMap, Low, !Ref EnvironmentType ]
  NormalAmount:
    Description: The Normal Amount used to calculate Alarm Thresholds
    Value: !FindInMap [ ThresholdMap, Normal, !Ref EnvironmentType ]
  HighAmount:
    Description: The High Amount used to calculate Alarm Thresholds
    Value: !FindInMap [ ThresholdMap, High, !Ref EnvironmentType ]
  NormalAlarms:
    Description: The number of Alarms created to monitor the LowAmount to NormalAmount range
    Value: !FindInMap [ AlarmsMap, Normal, !Ref EnvironmentType ]
  HighAlarms:
    Description: The number of Alarms created to monitor the NormalAmount to HighAmount range
    Value: !FindInMap [ AlarmsMap, High, !Ref EnvironmentType ]
