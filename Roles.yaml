AWSTemplateFormatVersion: 2010-09-09
Description: Roles Template.
  This creates IAM Roles. These are not Application specific. Roles should be kept in 1:1 sync with Groups, to insure IAM Users and Federated Users have the same permissions.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Identity Provider Dependencies
        Parameters:
          - SamlProviderName
    ParameterLabels:
      SamlProviderName:
        default: SAML Provider Name
Parameters:
  SamlProviderName:
    Description: Name of the SAML Provider
    Type: String
    Default: ''
    AllowedPattern: (^$|^[-.a-zA-Z0-9]{2,64}$)
    ConstraintDescription: must begin with a letter and contain alphanumeric characters, dashes and periods, or blank.
Rules:
  ValidateRegion:
    Assertions:
      - Assert: !Equals [ !Ref 'AWS::Region', us-east-1 ]
        AssertDescription: This Template can only be used in Region us-east-1.
Conditions:
  ConfigureSamlRoles: !Not [ !Equals [ !Ref SamlProviderName, '' ]]
Resources:
  AdministratorsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: Administrators
      Path: /
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Sub arn:aws:iam::${AWS::AccountId}:saml-provider/${SamlProviderName}
            Action:
              - sts:AssumeRoleWithSAML
            Condition:
              StringEquals:
                SAML:aud: https://signin.aws.amazon.com/saml
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess
    Condition: ConfigureSamlRoles
  ManagedInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: ManagedInstance
      Path: /
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonSSMDirectoryServiceAccess
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
Outputs:
  AdministratorsRole:
    Description: The AdministratorsRole Name
    Value: !Ref AdministratorsRole
    Export:
      Name: !Sub ${AWS::StackName}-AdministratorsRole
    Condition: ConfigureSamlRoles
  ManagedInstanceRole:
    Description: The ManagedInstanceRole Name
    Value: !Ref ManagedInstanceRole
    Export:
      Name: !Sub ${AWS::StackName}-ManagedInstanceRole
